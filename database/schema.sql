-- EduFlow schema for Oracle

CREATE TABLE ROLES (
  role_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  role_name VARCHAR2(20) UNIQUE NOT NULL
);

CREATE TABLE USERS (
  user_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR2(100) NOT NULL,
  email VARCHAR2(120) UNIQUE NOT NULL,
  password VARCHAR2(120) NOT NULL,
  role_id NUMBER NOT NULL,
  CONSTRAINT fk_users_role FOREIGN KEY (role_id) REFERENCES ROLES(role_id)
);

CREATE TABLE DEPARTMENTS (
  dept_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  dept_name VARCHAR2(100) UNIQUE NOT NULL
);

CREATE TABLE BATCHES (
  batch_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  dept_id NUMBER NOT NULL,
  year NUMBER(4) NOT NULL,
  CONSTRAINT fk_batches_dept FOREIGN KEY (dept_id) REFERENCES DEPARTMENTS(dept_id)
);

CREATE TABLE SECTIONS (
  section_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  batch_id NUMBER NOT NULL,
  section_name VARCHAR2(10) NOT NULL,
  CONSTRAINT ck_sections_name CHECK (UPPER(section_name) IN ('A','B','C','D')),
  CONSTRAINT fk_sections_batch FOREIGN KEY (batch_id) REFERENCES BATCHES(batch_id)
);

CREATE TABLE TEACHERS (
  teacher_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id NUMBER NOT NULL,
  CONSTRAINT fk_teachers_user FOREIGN KEY (user_id) REFERENCES USERS(user_id)
);

CREATE TABLE SUBJECTS (
  subject_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  subject_code VARCHAR2(50) UNIQUE NOT NULL,
  name VARCHAR2(120) NOT NULL,
  dept_id NUMBER NOT NULL,
  CONSTRAINT fk_subjects_dept FOREIGN KEY (dept_id) REFERENCES DEPARTMENTS(dept_id)
);

CREATE TABLE CLASSROOMS (
  room_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  room_name VARCHAR2(50) UNIQUE NOT NULL,
  capacity NUMBER NOT NULL
);

CREATE TABLE SCHEDULE (
  schedule_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  dept_id NUMBER NOT NULL,
  batch_id NUMBER NOT NULL,
  section_id NUMBER NOT NULL,
  subject_id NUMBER NOT NULL,
  teacher_id NUMBER NOT NULL,
  room_id NUMBER NOT NULL,
  day VARCHAR2(10) NOT NULL,
  time_start DATE NOT NULL,
  time_end DATE NOT NULL,
  status VARCHAR2(20) DEFAULT 'APPROVED' NOT NULL,
  last_updated TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
  CONSTRAINT fk_schedule_dept FOREIGN KEY (dept_id) REFERENCES DEPARTMENTS(dept_id),
  CONSTRAINT fk_schedule_batch FOREIGN KEY (batch_id) REFERENCES BATCHES(batch_id),
  CONSTRAINT fk_schedule_section FOREIGN KEY (section_id) REFERENCES SECTIONS(section_id),
  CONSTRAINT fk_schedule_subject FOREIGN KEY (subject_id) REFERENCES SUBJECTS(subject_id),
  CONSTRAINT fk_schedule_teacher FOREIGN KEY (teacher_id) REFERENCES TEACHERS(teacher_id),
  CONSTRAINT fk_schedule_room FOREIGN KEY (room_id) REFERENCES CLASSROOMS(room_id),
  CONSTRAINT ck_schedule_day CHECK (day IN ('Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'))
);

CREATE TABLE SCHEDULE_REQUESTS (
  request_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  teacher_id NUMBER NOT NULL,
  proposed_data CLOB NOT NULL,
  status VARCHAR2(20) DEFAULT 'PENDING' NOT NULL,
  submitted_at TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
  reviewed_at TIMESTAMP,
  admin_id NUMBER,
  CONSTRAINT fk_requests_teacher FOREIGN KEY (teacher_id) REFERENCES TEACHERS(teacher_id),
  CONSTRAINT fk_requests_admin FOREIGN KEY (admin_id) REFERENCES USERS(user_id)
);

CREATE TABLE ANNOUNCEMENTS (
  announcement_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  message VARCHAR2(500) NOT NULL,
  created_at TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
  posted_by_user_id NUMBER,
  CONSTRAINT fk_announcements_user FOREIGN KEY (posted_by_user_id) REFERENCES USERS(user_id)
);

CREATE TABLE DAY_SETTINGS (
  day_name VARCHAR2(10) PRIMARY KEY,
  day_type VARCHAR2(20) NOT NULL,
  updated_by NUMBER,
  updated_at TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
  CONSTRAINT ck_day_type CHECK (day_type IN ('WORKING','WEEKEND','HOLIDAY')),
  CONSTRAINT fk_day_settings_admin FOREIGN KEY (updated_by) REFERENCES USERS(user_id)
);
